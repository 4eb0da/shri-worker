<!DOCTYPE html>
<!-- saved from url=(0059)https://github.yandex-team.ru/pages/4eb0da/jekyller-worker/ -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Воркеры и PWA</title>
    
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="./Воркеры и PWA_files/screen-16x9.css">
    <style>
/* собственные стили можно писать здесь!! */

.scope {
    font-size: 120%;
}

.scope .next {
    visibility: visible;
}

.domain.active {
    border-bottom: 10px solid #44d44a;
}
.path.active {
    border-bottom: 10px solid #4446d4;
}

.event {
    display: inline-block;
    text-indent: 0;
    background: #fc0;
    border-radius: 36px;
    padding: 0 22px;
    margin-left: 16px;
}

.event__icon {
    vertical-align: middle;
    margin-right: 12px;
}

.worker {
    display: inline-block;
    text-indent: 0;
    background: #4eb0da;
    border-radius: 36px;
    padding: 0 22px;
    margin-left: 16px;
}

.manifest .selected {
    background: #fc0;
    border-radius: 32px;
    padding: 10px;
    margin: -10px;
}

.image-centered h2 {
    height: 100%;
    text-align: center;
}

.image-centered img {
    height: 100%;
}
</style>
</head>
<body class="shower list">
    <header class="caption">
        <h1>Воркеры и PWA</h1>
        <p>Александр Нефедов, <a href="http://yandex.ru/">Яндекс</a></p>

    </header>

    

<!-- slide #1 -->        
<section class="slide cover" id="1"><div><h2><img src="./Воркеры и PWA_files/logo-ru.svg" alt="" class="logo"></h2>

</div></section>

<!-- slide #2 -->
<section class="slide title" id="воркеры-и-pwa"><div><h2>Воркеры и PWA</h2>

<h3 id="-1"><img src="./Воркеры и PWA_files/title-logo-ru.svg" alt=""></h3>

<div class="authors">

<p>Александр Нефедов</p>




</div>

</div></section>

<!-- slide #3 -->
<section class="slide section" id="описание"><div><h2>Описание</h2>

</div></section>

<!-- slide #4 -->
<section class="slide" id="workers"><div><h2>Workers</h2>

<ul>
  <li class="next">Web Workers</li>
  <li class="next">Shared Workers</li>
  <li class="next">Service Workers</li>
</ul>

</div></section>

<!-- slide #5 -->
<section class="slide" id="web-worker"><div><h2>Web Worker</h2>

<p>Используется для вынесения работы в отдельный поток</p>

</div></section>

<!-- slide #6 -->
<section class="slide" id="web-worker---какие-кейсы"><div><h2>Web Worker - какие кейсы?</h2>

<ul>
  <li>Сложные вычисления</li>
  <li>Использование нескольких потоков</li>
  <li>Реалтаймовая обработка</li>
</ul>

</div></section>

<!-- slide #7 -->
<section class="slide" id="shared-worker"><div><h2>Shared Worker</h2>

<p>Используется для вынесения работы в отдельный поток, который доступен из нескольких вкладок</p>

</div></section>

<!-- slide #8 -->
<section class="slide" id="shared-worker-поддержка"><div><h2>Shared Worker, поддержка</h2>

<ul>
  <li>Safari: удалена</li>
  <li>Edge: нет поддержки</li>
</ul>

</div></section>

<!-- slide #9 -->
<section class="slide" id="service-worker"><div><h2>Service Worker</h2>

<p>Используется как прокси между браузером и сервером, а также для ряда других вещей</p>

</div></section>

<!-- slide #10 -->
<section class="slide" id="service-worker---какие-кейсы"><div><h2>Service Worker - какие кейсы?</h2>

<ul>
  <li>Оффлайн</li>
  <li>Уведомления</li>
  <li>Background sync</li>
  <li>Сложные манипуляции с запросами со страницы</li>
</ul>

</div></section>

<!-- slide #11 -->
<section class="slide" id="worklets"><div><h2>Worklets</h2>

<p>Worklet – упрощённая версия Web Worker для специфичных задач</p>

<ul>
  <li>AudioWorklet</li>
  <li>AnimationWorklet</li>
  <li>PaintWorklet</li>
  <li>LayoutWorklet</li>
</ul>

</div></section>

<!-- slide #12 -->
<section class="slide" id="workerglobalscope"><div><h2>WorkerGlobalScope</h2>

<ul>
  <li>self</li>
  <li>navigator</li>
  <li>location</li>
  <li>console</li>
</ul>

</div></section>

<!-- slide #13 -->
<section class="slide" id="workerglobalscope-1"><div><h2>WorkerGlobalScope</h2>

<ul>
  <li>XMLHttpRequest</li>
  <li>WebSocket</li>
  <li>indexedDB</li>
  <li>caches</li>
</ul>

</div></section>

<!-- slide #14 -->
<section class="slide" id="workerglobalscope-2"><div><h2>WorkerGlobalScope</h2>

<ul>
  <li>postMessage</li>
  <li>onmessage</li>
</ul>

</div></section>

<!-- slide #15 -->
<section class="slide" id="workerglobalscope-3"><div><h2>WorkerGlobalScope</h2>

<ul>
  <li>Нет доступа к DOM</li>
</ul>

</div></section>

<!-- slide #16 -->
<section class="slide" id="pwa"><div><h2>PWA</h2>

<p><strong>PWA – прогрессивные веб-приложения</strong></p>

</div></section>

<!-- slide #17 -->
<section class="slide section" id="web-workers"><div><h2>Web Workers</h2>

</div></section>

<!-- slide #18 -->
<section class="slide" id="создание"><div><h2>Создание</h2>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// script.js</span>
<span class="kd">let</span> <span class="nx">worker</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Worker</span><span class="p">(</span><span class="s1">'worker.js'</span><span class="p">);</span>

<span class="nx">worker</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">({</span><span class="na">inputData</span><span class="p">:</span> <span class="s1">'...'</span><span class="p">});</span>

<span class="nx">worker</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
<span class="p">};</span>

<span class="c1">// worker.js</span>
<span class="nb">self</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">postMessage</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">data</span> <span class="o">+</span> <span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div></div>

</div></section>

<!-- slide #19 -->
<section class="slide" id="создание-из-строки"><div><h2>Создание из строки</h2>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">blob</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Blob</span><span class="p">([</span><span class="nx">code</span><span class="p">],</span> <span class="p">{</span><span class="na">type</span><span class="p">:</span> <span class="s1">'text/javascript'</span><span class="p">});</span>
<span class="kd">let</span> <span class="nx">worker</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Worker</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">createObjectURL</span><span class="p">(</span><span class="nx">blob</span><span class="p">));</span>
</code></pre></div></div>

</div></section>

<!-- slide #20 -->
<section class="slide" id="структурное-копирование"><div><h2>Структурное копирование</h2>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// script.js</span>
<span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span><span class="na">inputData</span><span class="p">:</span> <span class="s1">'...'</span><span class="p">};</span>
<span class="nx">worker</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>

<span class="c1">// worker.js</span>
<span class="nb">self</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// event.data !== data</span>
<span class="p">};</span>
</code></pre></div></div>

</div></section>

<!-- slide #21 -->
<section class="slide" id="передача-объектов"><div><h2>Передача объектов</h2>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">ArrayBuffer</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
<span class="nx">worker</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">({</span><span class="na">input</span><span class="p">:</span> <span class="nx">data</span><span class="p">},</span> <span class="p">[</span><span class="nx">data</span><span class="p">]);</span>

<span class="c1">// data.byteLength</span>
<span class="c1">// =&gt; 0</span>
</code></pre></div></div>

</div></section>

<!-- slide #22 -->
<section class="slide" id="sharedarraybuffer"><div><h2>SharedArrayBuffer</h2>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SharedArrayBuffer</span><span class="p">(</span><span class="mi">512</span><span class="p">);</span>
<span class="nx">worker</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">({</span><span class="na">input</span><span class="p">:</span> <span class="nx">data</span><span class="p">});</span>

<span class="kd">const</span> <span class="nx">localArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Int32Array</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>

<span class="c1">// ...</span>

<span class="nx">localArray</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
</code></pre></div></div>

</div></section>

<!-- slide #23 -->
<section class="slide" id="sharedarraybuffer--перекрёстный-доступ"><div><h2>SharedArrayBuffer – перекрёстный доступ</h2>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// script.js</span>
<span class="nx">localArray</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
</code></pre></div></div>

</div></section>

<!-- slide #24 -->
<section class="slide" id="sharedarraybuffer--перекрёстный-доступ-1"><div><h2>SharedArrayBuffer – перекрёстный доступ</h2>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// script.js</span>
<span class="kd">let</span> <span class="nx">val</span> <span class="o">=</span> <span class="nx">localArray</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
<span class="nx">localArray</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</code></pre></div></div>

</div></section>

<!-- slide #25 -->
<section class="slide" id="sharedarraybuffer--перекрёстный-доступ-2"><div><h2>SharedArrayBuffer – перекрёстный доступ</h2>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// worker.js</span>
<span class="nx">localArray</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
</code></pre></div></div>

</div></section>

<!-- slide #26 -->
<section class="slide" id="sharedarraybuffer--перекрёстный-доступ-3"><div><h2>SharedArrayBuffer – перекрёстный доступ</h2>

<p><code class="next">[..., 7, ...]</code><br>
<code class="next">[..., 8, ...]</code><br>
<code class="next">[..., 8, ...]</code></p>

</div></section>

<!-- slide #27 -->
<section class="slide" id="sharedarraybuffer--atomics"><div><h2>SharedArrayBuffer – Atomics</h2>

<p>Atomics позволяют выполнять операции в одном потоке в один момент времени.</p>

</div></section>

<!-- slide #28 -->
<section class="slide" id="sharedarraybuffer--atomics-1"><div><h2>SharedArrayBuffer – Atomics</h2>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">Atomics</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">loadArray</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="nx">Atomics</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">loadArray</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>

<span class="nx">Atomics</span><span class="p">.</span><span class="nx">store</span><span class="p">(</span><span class="nx">loadArray</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</code></pre></div></div>

</div></section>

<!-- slide #29 -->
<section class="slide" id="webassembly"><div><h2>WebAssembly</h2>

<p>WebAssembly код можно запускать в независимых воркерах, при этом шарить память воркеров друг с другом</p>

</div></section>

<!-- slide #30 -->
<section class="slide" id="библиотеки"><div><h2>Библиотеки</h2>

<ul>
  <li class="next"><a href="https://github.com/web-perf/react-worker-dom">React worker dom</a></li>
  <li class="next"><a href="https://github.com/vincentriemer/react-native-dom">React native dom</a></li>
  <li class="next"><a href="https://github.com/ampproject/worker-dom">WorkerDOM</a></li>
</ul>

</div></section>

<!-- slide #31 -->
<section class="slide section" id="manifest"><div><h2>Manifest</h2>

</div></section>

<!-- slide #32 -->
<section class="slide" id="manifestjson"><div><h2>manifest.json</h2>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;head&gt;</span>
    ...
    <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"manifest"</span> <span class="na">href=</span><span class="s">"manifest.json"</span><span class="nt">&gt;</span>
    ...
<span class="nt">&lt;/head&gt;</span>
</code></pre></div></div>

</div></section>

<!-- slide #33 -->
<section class="slide" id="manifestjson-1"><div><h2>manifest.json</h2>

<pre class="highlight"><code class="manifest"><span class="p">{</span><span class="w">
  </span><span class="s2 selected">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Яндекс"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"short_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Яндекс"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"start_url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/?from=homescreen"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"display"</span><span class="p">:</span><span class="w"> </span><span class="s2">"browser"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"background_color"</span><span class="p">:</span><span class="w"> </span><span class="s2">"#FFFFFF"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"theme_color"</span><span class="p">:</span><span class="w"> </span><span class="s2">"#FFFFFF"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"icons"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w">
    </span><span class="s2">"src"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://yastatic.net/morda-logo/i/logo-single/192x192_ru_v2.png"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"sizes"</span><span class="p">:</span><span class="w"> </span><span class="s2">"192x192"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"image/png"</span><span class="w">
  </span><span class="p">}]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code>
</pre>

</div></section>

<!-- slide #34 -->
<section class="slide" id="manifestjson-2"><div><h2>manifest.json</h2>

<pre class="highlight"><code class="manifest"><span class="p">{</span><span class="w">
  </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Яндекс"</span><span class="p">,</span><span class="w">
  </span><span class="s2 selected">"short_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Яндекс"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"start_url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/?from=homescreen"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"display"</span><span class="p">:</span><span class="w"> </span><span class="s2">"browser"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"background_color"</span><span class="p">:</span><span class="w"> </span><span class="s2">"#FFFFFF"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"theme_color"</span><span class="p">:</span><span class="w"> </span><span class="s2">"#FFFFFF"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"icons"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w">
    </span><span class="s2">"src"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://yastatic.net/morda-logo/i/logo-single/192x192_ru_v2.png"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"sizes"</span><span class="p">:</span><span class="w"> </span><span class="s2">"192x192"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"image/png"</span><span class="w">
  </span><span class="p">}]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code>
</pre>

</div></section>

<!-- slide #35 -->
<section class="slide" id="manifestjson-3"><div><h2>manifest.json</h2>

<pre class="highlight"><code class="manifest"><span class="p">{</span><span class="w">
  </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Яндекс"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"short_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Яндекс"</span><span class="p">,</span><span class="w">
  </span><span class="s2 selected">"start_url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/?from=homescreen"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"display"</span><span class="p">:</span><span class="w"> </span><span class="s2">"browser"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"background_color"</span><span class="p">:</span><span class="w"> </span><span class="s2">"#FFFFFF"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"theme_color"</span><span class="p">:</span><span class="w"> </span><span class="s2">"#FFFFFF"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"icons"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w">
    </span><span class="s2">"src"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://yastatic.net/morda-logo/i/logo-single/192x192_ru_v2.png"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"sizes"</span><span class="p">:</span><span class="w"> </span><span class="s2">"192x192"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"image/png"</span><span class="w">
  </span><span class="p">}]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code>
</pre>

</div></section>

<!-- slide #36 -->
<section class="slide" id="manifestjson-4"><div><h2>manifest.json</h2>

<pre class="highlight"><code class="manifest"><span class="p">{</span><span class="w">
  </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Яндекс"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"short_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Яндекс"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"start_url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/?from=homescreen"</span><span class="p">,</span><span class="w">
  </span><span class="s2 selected">"display"</span><span class="p">:</span><span class="w"> </span><span class="s2">"browser"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"background_color"</span><span class="p">:</span><span class="w"> </span><span class="s2">"#FFFFFF"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"theme_color"</span><span class="p">:</span><span class="w"> </span><span class="s2">"#FFFFFF"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"icons"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w">
    </span><span class="s2">"src"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://yastatic.net/morda-logo/i/logo-single/192x192_ru_v2.png"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"sizes"</span><span class="p">:</span><span class="w"> </span><span class="s2">"192x192"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"image/png"</span><span class="w">
  </span><span class="p">}]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code>
</pre>

</div></section>

<!-- slide #37 -->
<section class="slide" id="manifestjson-5"><div><h2>manifest.json</h2>

<pre class="highlight"><code class="manifest"><span class="p">{</span><span class="w">
  </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Яндекс"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"short_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Яндекс"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"start_url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/?from=homescreen"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"display"</span><span class="p">:</span><span class="w"> </span><span class="s2">"browser"</span><span class="p">,</span><span class="w">
  </span><span class="s2 selected">"background_color"</span><span class="p">:</span><span class="w"> </span><span class="s2">"#FFFFFF"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"theme_color"</span><span class="p">:</span><span class="w"> </span><span class="s2">"#FFFFFF"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"icons"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w">
    </span><span class="s2">"src"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://yastatic.net/morda-logo/i/logo-single/192x192_ru_v2.png"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"sizes"</span><span class="p">:</span><span class="w"> </span><span class="s2">"192x192"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"image/png"</span><span class="w">
  </span><span class="p">}]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code>
</pre>

</div></section>

<!-- slide #38 -->
<section class="slide" id="manifestjson-6"><div><h2>manifest.json</h2>

<pre class="highlight"><code class="manifest"><span class="p">{</span><span class="w">
  </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Яндекс"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"short_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Яндекс"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"start_url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/?from=homescreen"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"display"</span><span class="p">:</span><span class="w"> </span><span class="s2">"browser"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"background_color"</span><span class="p">:</span><span class="w"> </span><span class="s2">"#FFFFFF"</span><span class="p">,</span><span class="w">
  </span><span class="s2 selected">"theme_color"</span><span class="p">:</span><span class="w"> </span><span class="s2">"#FFFFFF"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"icons"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w">
    </span><span class="s2">"src"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://yastatic.net/morda-logo/i/logo-single/192x192_ru_v2.png"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"sizes"</span><span class="p">:</span><span class="w"> </span><span class="s2">"192x192"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"image/png"</span><span class="w">
  </span><span class="p">}]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code>
</pre>

</div></section>

<!-- slide #39 -->
<section class="slide" id="manifestjson-7"><div><h2>manifest.json</h2>

<pre class="highlight"><code class="manifest"><span class="p">{</span><span class="w">
  </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Яндекс"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"short_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Яндекс"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"start_url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/?from=homescreen"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"display"</span><span class="p">:</span><span class="w"> </span><span class="s2">"browser"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"background_color"</span><span class="p">:</span><span class="w"> </span><span class="s2">"#FFFFFF"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"theme_color"</span><span class="p">:</span><span class="w"> </span><span class="s2">"#FFFFFF"</span><span class="p">,</span><span class="w">
  </span><span class="s2 selected">"icons"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w">
    </span><span class="s2">"src"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://yastatic.net/morda-logo/i/logo-single/192x192_ru_v2.png"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"sizes"</span><span class="p">:</span><span class="w"> </span><span class="s2">"192x192"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"image/png"</span><span class="w">
  </span><span class="p">}]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code>
</pre>

</div></section>

<!-- slide #40 -->
<section class="slide section" id="pwa-1"><div><h2>PWA</h2>

</div></section>

<!-- slide #41 -->
<section class="slide" id="фичи"><div><h2>Фичи</h2>

<ul>
  <li>Работа без интернета</li>
  <li>Уведомления (push)</li>
  <li>Фоновая синхронизация (background sync)</li>
</ul>

</div></section>

<!-- slide #42 -->
<section class="slide" id="другие-фичи"><div><h2>Другие фичи</h2>

<ul>
  <li>Поделяшки (share)</li>
  <li>Оплата (payment api)</li>
  <li>Фоновая загрузка (background fetch)</li>
  <li>Авторизация (credentials api)</li>
  <li>Список контактов (contacts api)</li>
  <li>Метки (badges api)</li>
</ul>

</div></section>

<!-- slide #43 -->
<section class="slide" id="service-workers--базовая-поддержка"><div><h2>Service Workers – базовая поддержка</h2>

<ul>
  <li>Edge 16+</li>
  <li>Safari 11.3+</li>
  <li>Firefox 44+</li>
  <li>Chrome 40+</li>
</ul>

</div></section>

<!-- slide #44 -->
<section class="slide" id="desktop-pwa"><div><h2>Desktop PWA</h2>

<ul>
  <li>Edge 17+</li>
  <li>Chrome 70+ (Windows / Linux)</li>
</ul>

</div></section>

<!-- slide #45 -->
<section class="slide section" id="service-workers"><div><h2>Service Workers</h2>

</div></section>

<!-- slide #46 -->
<section class="slide" id="scope"><div><h2>Scope</h2>

<p class="scope">
    <span class="next domain">https://domain</span><span class="next path">/path</span>
</p>

<p class="next">На одном домене может быть много сервис-воркеров</p>

<p class="next">На комбинации origin + path может быть только один активный service-worker</p>

</div></section>

<!-- slide #47 -->
<section class="slide" id="установка"><div><h2>Установка</h2>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="s1">'serviceWorker'</span> <span class="k">in</span> <span class="nb">navigator</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">navigator</span><span class="p">.</span><span class="nx">serviceWorker</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="s1">'/path/sw.js'</span><span class="p">,</span> <span class="p">{</span><span class="na">scope</span><span class="p">:</span> <span class="s1">'/path/'</span><span class="p">})</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">reg</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Установка успешно'</span><span class="p">,</span> <span class="nx">reg</span><span class="p">);</span>
        <span class="p">}).</span><span class="k">catch</span><span class="p">((</span><span class="nx">error</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Установка не установка'</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
        <span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div>

</div></section>

<!-- slide #48 -->
<section class="slide" id="жизненный-процесс-воркера"><div><h2>Жизненный процесс воркера</h2>

<ul>
  <li>installing<span class="event next"><svg class="event__icon" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 8.467 8.467"><path d="M4.233.794l-2.38 3.44 2.38.529L.53 8.203l6.615-3.705L4.498 3.44l2.646-2.382z" fill-rule="evenodd"></path></svg>install</span></li>
  <li class="next">installed</li>
  <li class="next">activating<span class="event next"><svg class="event__icon" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 8.467 8.467"><path d="M4.233.794l-2.38 3.44 2.38.529L.53 8.203l6.615-3.705L4.498 3.44l2.646-2.382z" fill-rule="evenodd"></path></svg>activate</span></li>
  <li class="next">active</li>
</ul>

</div></section>

<!-- slide #49 -->
<section class="slide" id="обновление"><div><h2>Обновление</h2>

<ul>
  <li>installing</li>
  <li>installed</li>
  <li>activating</li>
  <li>active<span class="worker">worker 1</span></li>
</ul>

</div></section>

<!-- slide #50 -->
<section class="slide" id="обновление-1"><div><h2>Обновление</h2>

<ul>
  <li>installing<span class="worker">worker 2</span></li>
  <li>installed</li>
  <li>activating</li>
  <li>active<span class="worker">worker 1</span></li>
</ul>

</div></section>

<!-- slide #51 -->
<section class="slide" id="обновление-2"><div><h2>Обновление</h2>

<ul>
  <li>installing</li>
  <li>installed<span class="worker">worker 2</span></li>
  <li>activating</li>
  <li>active<span class="worker">worker 1</span></li>
</ul>

</div></section>

<!-- slide #52 -->
<section class="slide" id="обновление-3"><div><h2>Обновление</h2>

<ul>
  <li>installing</li>
  <li>installed<span class="worker">worker 2</span></li>
  <li>activating</li>
  <li>active</li>
</ul>

</div></section>

<!-- slide #53 -->
<section class="slide" id="обновление-4"><div><h2>Обновление</h2>

<ul>
  <li>installing</li>
  <li>installed</li>
  <li>activating<span class="worker">worker 2</span></li>
  <li>active</li>
</ul>

</div></section>

<!-- slide #54 -->
<section class="slide" id="обновление-5"><div><h2>Обновление</h2>

<ul>
  <li>installing</li>
  <li>installed</li>
  <li>activating</li>
  <li>active<span class="worker">worker 2</span></li>
</ul>

</div></section>

<!-- slide #55 -->
<section class="slide" id="событие-install"><div><h2>Событие install</h2>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">self</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'install'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">waitUntil</span><span class="p">(</span>
        <span class="nx">caches</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s1">'app-v1'</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">cache</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">addAll</span><span class="p">([</span>
                <span class="s1">'/index.html'</span><span class="p">,</span>
                <span class="s1">'/static/style.css'</span><span class="p">,</span>
                <span class="s1">'/static/main.js'</span>
            <span class="p">]);</span>
        <span class="p">})</span>
    <span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

</div></section>

<!-- slide #56 -->
<section class="slide" id="cache"><div><h2>Cache</h2>

<ul>
  <li>Доступны как в воркере, так и на странице</li>
  <li>Позволяют хранить ответы на запросы</li>
  <li>Можно положить в том числе простой текст</li>
</ul>

</div></section>

<!-- slide #57 -->
<section class="slide" id="событие-activate"><div><h2>Событие activate</h2>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">self</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'activate'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">waitUntil</span><span class="p">(</span>
        <span class="nx">caches</span><span class="p">.</span><span class="nx">keys</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">cacheNames</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span>
                <span class="nx">cacheNames</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">cacheName</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">[</span><span class="s1">'app-v1'</span><span class="p">].</span><span class="nx">includes</span><span class="p">(</span><span class="nx">cacheName</span><span class="p">))</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="nx">caches</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="nx">cacheName</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">})</span>
            <span class="p">);</span>
        <span class="p">})</span>
    <span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

</div></section>

<!-- slide #58 -->
<section class="slide" id="sw-контролирующий-страницу"><div><h2>SW, контролирующий страницу</h2>

<p>Все новые заходы на страницы, попадающие под scope, будут контролироваться сервис-воркером</p>

</div></section>

<!-- slide #59 -->
<section class="slide" id="событие-fetch"><div><h2>Событие fetch</h2>

<ul>
  <li>Срабатывает на все запросы контролируемой страницы</li>
  <li>В том числе кроссдоменные</li>
  <li>В том числе запросы без CORS</li>
</ul>

</div></section>

<!-- slide #60 -->
<section class="slide" id="событие-fetch-1"><div><h2>Событие fetch</h2>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">self</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'fetch'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">respondWith</span><span class="p">(</span>
        <span class="nx">caches</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">request</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">response</span> <span class="o">||</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">request</span><span class="p">);</span>
        <span class="p">})</span>
    <span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

</div></section>

<!-- slide #61 -->
<section class="slide" id="стратегии-кеширования"><div><h2>Стратегии кеширования</h2>

<ul>
  <li>Cache first</li>
  <li>Network first</li>
</ul>

</div></section>

<!-- slide #62 -->
<section class="slide" id="кроссдоменные-запросы"><div><h2>Кроссдоменные запросы</h2>

<ul>
  <li class="next">Картинки по умолчанию грузятся в режиме no-cors</li>
  <li class="next">XMLHttpRequest всегда грузится в режиме cors</li>
  <li class="next">fetch позволяет управлять режимом запроса</li>
</ul>

</div></section>

<!-- slide #63 -->
<section class="slide" id="fetch-mode"><div><h2>fetch mode</h2>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">fetch</span><span class="p">(</span><span class="s1">'some.json'</span><span class="p">,</span> <span class="p">{</span><span class="na">mode</span><span class="p">:</span> <span class="s1">'cors'</span><span class="p">});</span>

<span class="nx">fetch</span><span class="p">(</span><span class="s1">'some.json'</span><span class="p">,</span> <span class="p">{</span><span class="na">mode</span><span class="p">:</span> <span class="s1">'no-cors'</span><span class="p">});</span>

<span class="nx">fetch</span><span class="p">(</span><span class="s1">'some.json'</span><span class="p">,</span> <span class="p">{</span><span class="na">mode</span><span class="p">:</span> <span class="s1">'same-origin'</span><span class="p">});</span>
</code></pre></div></div>

</div></section>

<!-- slide #64 -->
<section class="slide" id="проблемы"><div><h2>Проблемы</h2>

<ul>
  <li class="next">Сервис-воркер - не бесплатная мгновенная штука</li>
</ul>

</div></section>

<!-- slide #65 -->
<section class="slide" id="navigation-preload"><div><h2>Navigation preload</h2>

<p>Позволяет запустить запрос параллельно с запуском воркера</p>

</div></section>

<!-- slide #66 -->
<section class="slide" id="проблемы-1"><div><h2>Проблемы</h2>

<ul>
  <li class="next">Очень много нюансов</li>
  <li class="next">Уникальная возможность сломать всё</li>
</ul>

</div></section>

<!-- slide #67 -->
<section class="slide" id="сайты-и-инструменты"><div><h2>Сайты и инструменты</h2>

<ul>
  <li><a href="https://serviceworke.rs/">ServiceWorke.rs</a></li>
  <li><a href="https://developers.google.com/web/tools/workbox/">Workbox</a></li>
</ul>

</div></section>

<!-- slide #68 -->
<section class="slide section" id="пуш-уведомления"><div><h2>Пуш-уведомления</h2>

</div></section>

<!-- slide #69 -->
<section class="slide" id="что-делать"><div><h2>Что делать?</h2>

<ul>
  <li>Получить разрешение от пользователя</li>
</ul>

</div></section>

<!-- slide #70 -->
<section class="slide cover image-centered" id="-2"><div><h2><img src="./Воркеры и PWA_files/push3.png" alt=""></h2>

</div></section>

<!-- slide #71 -->
<section class="slide cover image-centered" id="-3"><div><h2><img src="./Воркеры и PWA_files/push4.png" alt=""></h2>

</div></section>

<!-- slide #72 -->
<section class="slide cover image-centered" id="-4"><div><h2><img src="./Воркеры и PWA_files/push5.png" alt=""></h2>

</div></section>

<!-- slide #73 -->
<section class="slide cover image-centered" id="-5"><div><h2><img src="./Воркеры и PWA_files/push6.png" alt=""></h2>

</div></section>

<!-- slide #74 -->
<section class="slide cover image-centered" id="-6"><div><h2><img src="./Воркеры и PWA_files/push7.png" alt=""></h2>

</div></section>

<!-- slide #75 -->
<section class="slide cover image-centered" id="-7"><div><h2><img src="./Воркеры и PWA_files/push8.png" alt=""></h2>

</div></section>

<!-- slide #76 -->
<section class="slide cover image-centered" id="-8"><div><h2><img src="./Воркеры и PWA_files/push9.png" alt=""></h2>

</div></section>

<!-- slide #77 -->
<section class="slide cover image-centered" id="-9"><div><h2><img src="./Воркеры и PWA_files/push10.png" alt=""></h2>

</div></section>

<!-- slide #78 -->
<section class="slide" id="получить-ключ-сервера"><div><h2>Получить ключ сервера</h2>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">fetch</span><span class="p">(</span><span class="s1">'./vapidPublicKey'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span> <span class="o">=&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">text</span><span class="p">());</span>

<span class="kd">let</span> <span class="nx">encodedKey</span> <span class="o">=</span> <span class="nx">urlBase64ToUint8Array</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
</code></pre></div></div>

</div></section>

<!-- slide #79 -->
<section class="slide" id="сконвертировать-ключ"><div><h2>Сконвертировать ключ</h2>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">urlBase64ToUint8Array</span><span class="p">(</span><span class="nx">base64String</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">padding</span> <span class="o">=</span> <span class="s1">'='</span><span class="p">.</span><span class="nx">repeat</span><span class="p">((</span><span class="mi">4</span> <span class="o">-</span> <span class="nx">base64String</span><span class="p">.</span><span class="nx">length</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">base64</span> <span class="o">=</span> <span class="p">(</span><span class="nx">base64String</span> <span class="o">+</span> <span class="nx">padding</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/</span><span class="se">\-</span><span class="sr">/g</span><span class="p">,</span> <span class="s1">'+'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/_/g</span><span class="p">,</span> <span class="s1">'/'</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">rawData</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">atob</span><span class="p">(</span><span class="nx">base64</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">outputArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Uint8Array</span><span class="p">(</span><span class="nx">rawData</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">rawData</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">outputArray</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">rawData</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">outputArray</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

</div></section>

<!-- slide #80 -->
<section class="slide" id="получить-информацию-о-подписке"><div><h2>Получить информацию о подписке</h2>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">navigator</span><span class="p">.</span><span class="nx">serviceWorker</span><span class="p">.</span><span class="nx">ready</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">registration</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">registration</span><span class="p">.</span><span class="nx">pushManager</span><span class="p">.</span><span class="nx">getSubscription</span><span class="p">()</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">subscription</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">subscription</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">subscription</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="nx">registration</span><span class="p">.</span><span class="nx">pushManager</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">({</span>
                <span class="na">userVisibleOnly</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
                <span class="na">applicationServerKey</span><span class="p">:</span> <span class="nx">encodedKey</span>
            <span class="p">});</span>
        <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

</div></section>

<!-- slide #81 -->
<section class="slide" id="обработать-событие-push"><div><h2>Обработать событие push</h2>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">self</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'push'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">payload</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>

    <span class="nx">event</span><span class="p">.</span><span class="nx">waitUntil</span><span class="p">(</span>
        <span class="nb">self</span><span class="p">.</span><span class="nx">registration</span><span class="p">.</span><span class="nx">showNotification</span><span class="p">(</span><span class="nx">payload</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span> <span class="p">{</span>
            <span class="na">body</span><span class="p">:</span> <span class="nx">payload</span><span class="p">.</span><span class="nx">body</span><span class="p">,</span>
            <span class="na">icon</span><span class="p">:</span> <span class="nx">payload</span><span class="p">.</span><span class="nx">icon</span><span class="p">,</span>
            <span class="na">data</span><span class="p">:</span> <span class="nx">payload</span>
        <span class="p">})</span>
    <span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

</div></section>

<!-- slide #82 -->
<section class="slide" id="обработка-клика-по-нотификации"><div><h2>Обработка клика по нотификации</h2>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">self</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'notificationclick'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">notification</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">notification</span><span class="p">,</span>
        <span class="nx">data</span> <span class="o">=</span> <span class="nx">notification</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>

    <span class="nx">notification</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">data</span> <span class="o">||</span> <span class="o">!</span><span class="nx">data</span><span class="p">.</span><span class="nx">openHref</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">waitUntil</span><span class="p">(</span>
        <span class="nb">self</span><span class="p">.</span><span class="nx">clients</span><span class="p">.</span><span class="nx">openWindow</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">openHref</span><span class="p">)</span>
    <span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

</div></section>

<!-- slide #83 -->
<section class="slide" id="мелочи"><div><h2>Мелочи</h2>

<p>У нотификаций много фичей:</p>

<ul>
  <li class="next">image</li>
  <li class="next">tag</li>
  <li class="next">vibrate</li>
  <li class="next">silent</li>
  <li class="next">actions</li>
</ul>

</div></section>

<!-- slide #84 -->
<section class="slide" id="мелочи-1"><div><h2>Мелочи</h2>

<ul>
  <li class="next">Разные воркеры - разные подписки</li>
  <li class="next">Обновление воркера сохраняет подписку</li>
  <li class="next">Нужно обновлять подписку по событию <code class="highlighter-rouge">pushsubscriptionchange</code></li>
  <li class="next">Стоит забывать подписки на сервере</li>
</ul>

</div></section>

<!-- slide #85 -->
<section class="slide" id="мелочи-2"><div><h2>Мелочи</h2>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">registration</span><span class="p">.</span><span class="nx">pushManager</span><span class="p">.</span><span class="nx">subscribe</span>

<span class="c1">// ==</span>

<span class="nx">Notification</span><span class="p">.</span><span class="nx">requestPermission</span>
</code></pre></div></div>

</div></section>

<!-- slide #86 -->
<section class="slide contacts" id="контакты"><div><h2>Контакты</h2>

<figure>

  <h3 id="section">Александр Нефедов</h3>

</figure>

<!-- разделитель контактов -->
<hr>

<!-- left -->
<ul>
  <li class="mail">4eb0da@yandex-team.ru</li>
  <li class="github">4eb0da</li>
</ul>

<!--

- {:.mail}author@yandex-team.ru
- {:.phone}+7-999-888-7766
- {:.github}author
- {:.bitbucket}author
- {:.twitter}@author
- {:.telegram}author
- {:.skype}author
- {:.instagram}author
- {:.facebook}author
- {:.vk}@author
- {:.ok}@author

-->

</div></section>

    
    <div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="-1" aria-valuetext="Slideshow Progress: -1%"></div>
    

    <script src="./Воркеры и PWA_files/shower.min.js"></script>
    <!-- Copyright © 2018 Александр Нефедов, Яндекс — http://yandex.ru/ -->


<section role="region" aria-live="assertive" aria-relevant="additions" aria-label="Slide Content: Auto-updating" class="region"></section></body></html>